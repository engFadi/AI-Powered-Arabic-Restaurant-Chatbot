 @{
ViewData["Title"] = "Login";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<style>
    body {
        background-color: #013220;
        font-family: 'Poppins', sans-serif;
        overflow: hidden;
        position: relative;
    }

    /* 🔹 Watermark container */
    .watermark {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 0;
        pointer-events: none;
        overflow: hidden;
    }

        .watermark span {
            position: absolute;
            font-size: 3rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.06);
            white-space: nowrap;
            transform: rotate(-45deg);
            animation: slideWatermark 60s linear infinite;
        }

    @@keyframes slideWatermark {
        0% {
            transform: rotate(-45deg) translate(0, 0);
        }

        100% {
            transform: rotate(-45deg) translate(-200px, -200px);
        }
    }

    /* 🔹 Login Card */
    .card {
        background-color: rgba(255, 255, 255, 0.92);
        border-radius: 15px;
        width: 50vw;
        max-width: 700px;
        min-width: 350px;
        z-index: 1;
        position: relative;
    }

    .yallaeat-footer {
        font-size: 0.9rem;
        font-weight: 500;
        color: #28a745;
        text-align: center;
        margin-top: 12px;
        z-index: 1;
        position: relative;
    }
</style>

<!-- Watermark background -->
<div class="watermark" id="watermark"></div>

<div class="d-flex justify-content-center align-items-center vh-100">
    <div>
        <div class="card shadow-lg p-4">
            <h3 class="text-center mb-4">تسجيل الدخول</h3>
            <div class="mb-3">
                <label for="username" class="form-label">اسم المستخدم</label>
                <input type="text" id="username" class="form-control" placeholder="ادخل اسم المستخدم" />
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">كلمة المرور</label>
                <input type="password" id="password" class="form-control" placeholder="ادخل كلمة المرور" />
            </div>

            <button onclick="login()" class="btn btn-success w-100">تسجيل الدخول</button>

            <div id="error" class="alert alert-danger mt-3 text-center d-none"></div>

            <div class="text-center mt-3">
                <p>ليس لديك حساب؟ <a href="@Url.Action("Register", "Auth")">سجل هنا</a></p>
            </div>
        </div>

        <div class="yallaeat-footer">
            YallaEat.<span style="color:#20c997;">AI</span>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 🔹 Fill username if present in query
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const username = params.get('username');
            if (username) document.getElementById('username').value = username;

            // 🔹 Generate dynamic watermark grid
            const watermark = document.getElementById('watermark');
            const rows = Math.ceil(window.innerHeight / 200);
            const cols = Math.ceil(window.innerWidth / 400);

            for (let r = 0; r <= rows; r++) {
                for (let c = 0; c <= cols; c++) {
                    const span = document.createElement('span');
                    span.innerText = "YallaEat.AI ";
                    span.style.top = `${r * 200}px`;
                    span.style.left = `${c * 400}px`;
                    watermark.appendChild(span);
                }
            }
        });

        // 🔹 Login function
        async function login() {
            const errorDiv = document.getElementById("error");
            errorDiv.classList.add("d-none");

            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();

            if (!username || !password) {
                errorDiv.innerText = "Username and password are required.";
                errorDiv.classList.remove("d-none");
                return;
            }

            try {
                const response = await fetch("/api/auth/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                if (response.ok) {
                    localStorage.setItem("token", result.token);
                    localStorage.setItem("role", result.role);
                    localStorage.setItem("userId", result.userId);
                    switch (result.role.toLowerCase()) {
                        case "admin": window.location.href = "/AdminPage/Cover"; break;
                        case "customer": window.location.href = "/api/Chat"; break;
                        default: window.location.href = "/Home/Index"; break;
                    }
                } else {
                    errorDiv.innerText = result.message || "Login failed";
                    errorDiv.classList.remove("d-none");
                }
            } catch {
                errorDiv.innerText = "An error occurred. Please try again.";
                errorDiv.classList.remove("d-none");
            }
        }
    </script>
}
